<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donate | Cuyahoga Valley Countryside Conservancy</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7f9;
      margin: 0;
      padding: 0;
      color: #1f2a44;
    }

    .page {
      max-width: 800px;
      margin: 0 auto;
      padding: 48px 16px 64px;
    }

    header {
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    p.lede {
      margin: 0;
      font-size: 16px;
      color: #2f3c56;
    }

    form {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #cfd6e0;
      border-radius: 4px;
      font-size: 15px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 80px;
    }

    .acknowledgment {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 14px;
      color: #2f3c56;
    }

    .acknowledgment input {
      width: auto;
      margin-top: 4px;
    }

    button {
      background: #1f6f43;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      padding: 12px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    button.secondary {
      background: #2f3c56;
    }

    .messages {
      margin-top: 16px;
    }

    .message {
      display: none;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .message.success {
      background: #e3f5eb;
      color: #1f6f43;
      border: 1px solid #b8e0c9;
    }

    .message.error {
      background: #fdecea;
      color: #b43c35;
      border: 1px solid #f5c1bc;
    }

    .receipt-preview {
      margin-top: 24px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 16px;
    }

    .receipt-preview h2 {
      margin-top: 0;
    }

    .muted {
      color: #56627a;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo">
        <img src="assets/imgs/img.logo.countryside.png" alt="Cuyahoga Valley Countryside Conservancy">
      </a>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="happenings.html">Happenings</a></li>
        <li><a href="profiles/trapp_family_farm.html">Farm Profiles</a></li>
        <li><a href="donate.html">Donate</a></li>
      </ul>
    </div>
  </nav>
  <main class="page">
    <header>
      <h1>Cuyahoga Valley Countryside Conservancy</h1>
      <p class="lede">Support our work with a tax-deductible gift. Complete the form to start your donation.</p>
    </header>

    <form id="donation-form" novalidate>
      <div>
        <label for="amount">Donation amount (USD)</label>
        <input id="amount" name="amount" type="number" min="0.01" step="0.01" placeholder="50.00" required>
      </div>

      <div>
        <label for="donor-name">Donor name</label>
        <input id="donor-name" name="donor-name" type="text" placeholder="Your full name" required>
      </div>

      <div>
        <label for="donor-email">Email</label>
        <input id="donor-email" name="donor-email" type="email" placeholder="you@example.com" required>
      </div>

      <div>
        <label for="designation">Designation (optional)</label>
        <textarea id="designation" name="designation" placeholder="Tell us if this gift should be designated to a specific program"></textarea>
      </div>

      <div>
        <label for="gateway">Gateway</label>
        <select id="gateway" name="gateway">
          <option value="direct">Direct (server-side donation)</option>
          <option value="paypal">PayPal</option>
        </select>
      </div>

      <div class="acknowledgment">
        <input type="checkbox" id="acknowledge" required>
        <label for="acknowledge">I acknowledge that no goods or services were provided in exchange for this contribution.</label>
      </div>

      <button type="submit">Start Donation</button>
    </form>

    <div class="messages">
      <div id="success-message" class="message success"></div>
      <div id="error-message" class="message error"></div>
    </div>

    <div class="receipt-preview">
      <h2>Receipt Preview</h2>
      <p><strong>Legal Name:</strong> Cuyahoga Valley Countryside Conservancy</p>
      <p><strong>EIN:</strong> <span id="preview-ein">(add EIN here)</span></p>
      <p><strong>Donation amount:</strong> $<span id="preview-amount">0.00</span></p>
      <p class="muted">Statement: No goods or services were provided in exchange for this donation.</p>
      <p class="muted">Provider-specific receipt details, transaction IDs, and fulfillment notes will appear here after wiring to Flask endpoints. <!-- TODO: populate with payment provider metadata (transaction id, approval link, payer id) once returned. --></p>
    </div>

    <section class="receipt-preview" style="margin-top: 16px;">
      <h2>Confirmation</h2>
      <p class="muted">After an approval is returned, confirm/capture the payment below.</p>
      <button id="confirm-button" class="secondary" type="button">Confirm / Capture</button>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <img src="assets/imgs/img.logo.countryside.png" alt="Cuyahoga Valley Countryside Conservancy" class="footer-logo">
          <p>Preserving farmland and supporting local agriculture in the Cuyahoga Valley.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="happenings.html">Happenings</a></li>
            <li><a href="profiles/trapp_family_farm.html">Farm Profiles</a></li>
            <li><a href="donate.html">Donate</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Contact</h4>
          <p>Email: info@cuyahogavalleycountrysideconservancy.org</p>
          <p>Phone: (330) 555-0100</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 Cuyahoga Valley Countryside Conservancy. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    const donationForm = document.getElementById('donation-form');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const previewAmount = document.getElementById('preview-amount');
    const confirmButton = document.getElementById('confirm-button');

    let lastDonationId = null;
    let lastOrderId = null;

    function setMessage(type, text) {
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';

      if (type === 'success') {
        successMessage.textContent = text;
        successMessage.style.display = 'block';
      }

      if (type === 'error') {
        errorMessage.textContent = text;
        errorMessage.style.display = 'block';
      }
    }

    donationForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      setMessage();

      const amountValue = parseFloat(donationForm.amount.value);
      if (Number.isNaN(amountValue) || amountValue <= 0) {
        setMessage('error', 'Please enter a donation amount greater than zero.');
        return;
      }

      if (!donationForm.acknowledge.checked) {
        setMessage('error', 'Please acknowledge that no goods or services were received.');
        return;
      }

      previewAmount.textContent = amountValue.toFixed(2);

      const gateway = donationForm.gateway.value;
      const isPaypal = gateway === 'paypal';
      const endpoint = isPaypal ? '/api/payments/paypal/create-order' : '/api/donations/create';

      const payload = {
        amount: amountValue,
        donor_name: donationForm['donor-name'].value,
        donor_email: donationForm['donor-email'].value,
        designation: donationForm.designation.value,
        return_url: 'https://example.org/donate/return', // TODO: update return URL
        cancel_url: 'https://example.org/donate/cancel', // TODO: update cancel URL
        acknowledgment: donationForm.acknowledge.checked,
        legal_name: 'Cuyahoga Valley Countryside Conservancy'
      };

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }

        const data = await response.json();
        // TODO: save invoice JSON to srv/webapps/clients/cuyahogavalleycountrysideconservancy.org/data under "Cuyahoga Valley Countryside Conservancy".

        if (isPaypal) {
          lastOrderId = data.order_id || data.id;
          setMessage('success', 'PayPal order created. Continue approval in the returned link or popup.');
        } else {
          lastDonationId = data.donation_id || data.id;
          setMessage('success', 'Donation initialized. Proceed to confirmation once approved.');
        }

        // TODO: surface provider approval links or instructions from the response for the donor to continue.
      } catch (error) {
        console.error('Donation creation failed', error);
        setMessage('error', 'We could not start your donation. Please try again or contact support.');
      }
    });

    confirmButton.addEventListener('click', async () => {
      setMessage();
      const gateway = donationForm.gateway.value;
      const isPaypal = gateway === 'paypal';

      const confirmEndpoint = isPaypal
        ? '/api/payments/paypal/capture-order'
        : '/api/donations/confirm';

      const idField = isPaypal ? lastOrderId : lastDonationId;
      if (!idField) {
        setMessage('error', 'No donation or order to confirm. Start a donation first.');
        return;
      }

      const payload = isPaypal ? { order_id: idField } : { donation_id: idField };

      try {
        const response = await fetch(confirmEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Confirm failed with status ${response.status}`);
        }

        const data = await response.json();
        setMessage('success', 'Donation confirmed and captured. A receipt will be emailed.');
        // TODO: enrich receipt preview with transaction info from `data` when endpoints are wired.
      } catch (error) {
        console.error('Confirmation failed', error);
        setMessage('error', 'Confirmation did not complete. Please retry after approval.');
      }
    });
  </script>
</body>
</html>
