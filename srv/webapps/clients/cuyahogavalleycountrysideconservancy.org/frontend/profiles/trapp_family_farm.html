<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farm Profiles | Cuyahoga Valley Countryside Conservancy</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    body {
      background: var(--bg);
      color: var(--text);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 48px 24px 64px;
      display: grid;
      gap: 32px;
    }

    .profiles-hero {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      display: grid;
      gap: 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.06);
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      font-weight: 800;
      color: var(--primary);
      margin: 0;
    }

    .profiles-hero h1 {
      margin: 0;
      font-size: 34px;
      color: var(--text);
      line-height: 1.2;
    }

    .profiles-hero p {
      margin: 0;
      color: var(--text-light);
      font-size: 17px;
      line-height: 1.6;
    }

    .jump-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    .jump-link {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--muted);
      color: var(--primary-dark);
      font-weight: 700;
      text-decoration: none;
      font-size: 13px;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .jump-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .farm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .farm-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.05);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .farm-media {
      position: relative;
      background: #f2f4f0;
    }

    .farm-scene {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .farm-logo {
      position: absolute;
      bottom: 12px;
      left: 12px;
      width: 76px;
      height: 76px;
      border-radius: 16px;
      background: #fff;
      padding: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 20px rgba(0, 0, 0, 0.08);
      object-fit: contain;
    }

    .farm-content {
      padding: 20px;
      display: grid;
      gap: 12px;
    }

    .farm-title {
      margin: 0;
      font-size: 22px;
      color: var(--text);
    }

    .tagline {
      margin: 0;
      color: var(--text-light);
      font-weight: 600;
      font-size: 15px;
    }

    .meta-row {
      display: grid;
      gap: 8px;
    }

    .meta-item {
      display: grid;
      grid-template-columns: 28px 1fr;
      gap: 10px;
      align-items: start;
      padding: 10px;
      border-radius: 10px;
      background: var(--muted);
      border: 1px solid var(--border);
    }

    .meta-item img {
      width: 20px;
      height: 20px;
      margin-top: 2px;
    }

    .meta-item .label {
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--primary-dark);
      font-weight: 800;
    }

    .meta-item .value, .meta-item a {
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
    }

    .highlights {
      margin: 0;
      padding-left: 18px;
      color: var(--text-light);
      display: grid;
      gap: 6px;
    }

    .links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--muted);
      color: var(--primary-dark);
      font-weight: 700;
      font-size: 12px;
      border: 1px solid var(--border);
    }

    @media (max-width: 720px) {
      .profiles-hero h1 { font-size: 28px; }
      .farm-scene { height: 180px; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="../index.html" class="logo">
        <img src="../assets/imgs/img.logo.conservancy.png" alt="Cuyahoga Valley Countryside Conservancy">
      </a>
      <ul class="nav-menu">
        <li><a href="../index.html">Home</a></li>
        <li><a href="../happenings.html">Happenings</a></li>
        <li><a href="trapp_family_farm.html">Farm Profiles</a></li>
        <li><a href="../donate.html">Donate</a></li>
      </ul>
    </div>
  </nav>

  <main class="page">
    <section class="profiles-hero">
      <p class="eyebrow">Farm Profiles</p>
      <h1>Meet the farmers cultivating the Cuyahoga Valley</h1>
      <p>Explore each participating farm with quick visuals, locations, and links. We paired every profile with its logo and a scene from the farm to help you recognize them at the market or on a visit.</p>
      <div class="jump-links" id="farm-jump-links"></div>
    </section>

    <section class="farm-grid" id="farm-grid"></section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <img src="../assets/imgs/img.logo.conservancy.png" alt="Cuyahoga Valley Countryside Conservancy" class="footer-logo">
          <p>Preserving farmland and supporting local agriculture in the Cuyahoga Valley.</p>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="../index.html">Home</a></li>
            <li><a href="../happenings.html">Happenings</a></li>
            <li><a href="trapp_family_farm.html">Farm Profiles</a></li>
            <li><a href="../donate.html">Donate</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Contact</h4>
          <p>Email: info@cuyahogavalleycountrysideconservancy.org</p>
          <p>Phone: (330) 555-0100</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 Cuyahoga Valley Countryside Conservancy. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    const farmGrid = document.getElementById('farm-grid');
    const jumpLinks = document.getElementById('farm-jump-links');
    const imageBasePath = '/data/CVCC_entities/';

    const normalizeArray = (data) => {
      if (!data) {
        return [];
      }
      if (Array.isArray(data)) {
        return data;
      }
      if (Array.isArray(data.legal_entity)) {
        return data.legal_entity;
      }
      return Object.values(data).filter((entry) => entry && entry.msn_id);
    };

    const resolveImagePath = (value) => {
      if (!value) {
        return `${imageBasePath}logo-default.png`;
      }
      if (value.startsWith('http') || value.startsWith('/')) {
        return value;
      }
      return `${imageBasePath}${value}`;
    };

    const toText = (value) => (value && value !== 'HERE' ? value : '');

    const slugify = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

    const renderSources = (sources) => {
      if (!sources.length) {
        return '';
      }
      const sourceLinks = sources.map((source) => {
        const label = source.replace(/^https?:\/\//, '').replace(/\/$/, '');
        if (source.startsWith('http')) {
          return `<a class="pill" href="https://${label}" target="_blank" rel="noreferrer">${label}</a>`;
        }
        return `<span class="pill">${source}</span>`;
      }).join('');
      return `<div class="links">${sourceLinks}</div>`;
    };

    const buildCard = (participant, legalEntity) => {
      const name = toText(legalEntity?.name_2)
        || toText(legalEntity?.name_1)
        || toText(legalEntity?.title)
        || toText(participant?.name)
        || 'Farm Profile';
      const slug = slugify(name || participant.msn_id);
      const logo = resolveImagePath(participant?.logo || legalEntity?.logo);
      const images = (participant?.images || legalEntity?.images || []).filter(Boolean).filter((value) => value !== 'HERE');
      const resolvedImages = images.map(resolveImagePath);
      const sceneImage = resolvedImages[0] || resolveImagePath();
      const principalParty = toText(participant?.principal_party_name);
      const address = toText(participant?.address || legalEntity?.address);
      const bio = (participant?.bio || legalEntity?.bio || [])
        .filter(Boolean)
        .filter((entry) => entry !== 'HERE');
      const bioText = bio.join(' ');
      const sources = Array.from(new Set([
        ...(participant?.sources || []),
        ...(legalEntity?.sources || [])
      ].filter(Boolean).filter((entry) => entry !== 'HERE')));
      const sourceMarkup = renderSources(sources);

      const metaItems = [
        address
          ? `<div class="meta-item">
              <img src="../assets/icons/icon.location.16171E.png" alt="Location icon">
              <div>
                <div class="label">Farm Location</div>
                <div class="value">${address}</div>
              </div>
            </div>`
          : '',
        principalParty
          ? `<div class="meta-item">
              <img src="../assets/icons/icon.personnel.16171E.png" alt="Principal party icon">
              <div>
                <div class="label">Principal Party</div>
                <div class="value">${principalParty}</div>
              </div>
            </div>`
          : ''
      ].join('');

      const galleryMarkup = resolvedImages.length > 1
        ? `<div class="links">${resolvedImages.slice(1).map((image, index) => (
          `<a class="pill" href="${image}" target="_blank" rel="noreferrer">Image ${index + 2}</a>`
        )).join('')}</div>`
        : '';

      return `
        <article class="farm-card" id="${slug}">
          <div class="farm-media">
            <img class="farm-scene" src="${sceneImage}" alt="${name} scene">
            <img class="farm-logo" src="${logo}" alt="${name} logo">
          </div>
          <div class="farm-content">
            <div>
              <h2 class="farm-title">${name}</h2>
              ${bioText ? `<p class="tagline">${bioText}</p>` : ''}
            </div>
            ${metaItems ? `<div class="meta-row">${metaItems}</div>` : ''}
            ${galleryMarkup}
            ${sourceMarkup}
          </div>
        </article>
      `;
    };

    const updateJumpLinks = (cards) => {
      if (!jumpLinks) {
        return;
      }
      jumpLinks.innerHTML = cards.map(({ id, title }) => (
        `<a class="jump-link" href="#${id}">${title}</a>`
      )).join('');
    };

    const loadProfiles = async () => {
      if (!farmGrid) {
        return;
      }
      try {
        const [participantResponse, legalEntityResponse] = await Promise.all([
          fetch('/api/backend-data/participant_farms.json'),
          fetch('/api/platform-data/msn_legal_entity.json')
        ]);
        const participantData = await participantResponse.json();
        const legalEntityData = await legalEntityResponse.json();
        const participantFarms = normalizeArray(participantData);
        const legalEntities = normalizeArray(legalEntityData);
        const legalEntityMap = new Map(legalEntities.map((entity) => [entity.msn_id, entity]));
        const cards = participantFarms.map((participant) => {
          const legalEntity = legalEntityMap.get(participant.msn_id);
          const name = toText(legalEntity?.name_2)
            || toText(legalEntity?.name_1)
            || toText(legalEntity?.title)
            || toText(participant?.name)
            || participant.msn_id;
          const id = slugify(name || participant.msn_id);
          return { html: buildCard(participant, legalEntity), id, title: name };
        });
        farmGrid.innerHTML = cards.map((card) => card.html).join('');
        updateJumpLinks(cards);
      } catch (error) {
        farmGrid.innerHTML = '<p>Farm profiles are temporarily unavailable. Please check back soon.</p>';
      }
    };

    loadProfiles();
  </script>
</body>
</html>
